<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Sarabun', sans-serif; }
    .hidden { display: none; }
    .preview-img { max-width: 100%; height: auto; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
    
    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô */
    .job-info-card {
        background-color: #e9ecef;
        border-left: 5px solid #0d6efd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status"></div>
  <div class="mt-2 text-primary fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="container" style="max-width: 600px;">
  
  <div class="text-center mb-3">
    <h4 id="pageTitle" class="fw-bold text-primary">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‚úÖ</h4>
    <div class="d-flex justify-content-center align-items-center gap-2 mt-2">
        <span class="badge bg-secondary">ID: <span id="jobIdDisplay">...</span></span>
    </div>
    <div id="userProfile" class="d-flex justify-content-center align-items-center gap-2 mt-2 hidden">
        <img id="userPicture" src="" style="width: 30px; height: 30px; border-radius: 50%;">
        <span id="userName" class="small text-dark fw-bold"></span>
    </div>
  </div>

  <div id="jobDetailSection" class="job-info-card hidden">
      <h6 class="fw-bold text-dark mb-1">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h6>
      <p class="mb-1 small text-muted">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: <span id="txtDetail" class="text-dark fw-bold">...</span></p>
      <p class="mb-1 small text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: <span id="txtLocation" class="text-dark">...</span></p>
      <p class="mb-0 small text-muted">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: <span id="txtReporter" class="text-dark">...</span></p>
  </div>
  <div id="loadingDetail" class="text-center small text-muted mb-3">
      ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô...
  </div>

  <form id="closeForm">
    <div class="mb-3">
      <label class="form-label fw-bold">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° / ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea class="form-control" id="remark" rows="3" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà, ‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÉ‡∏´‡∏°‡πà"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">üî© ‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
      <input type="text" class="form-control" id="material" placeholder="(‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)">
    </div>

    <div class="mb-3 hidden" id="extDateGroup">
      <label class="form-label text-danger fw-bold">üìÖ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" class="form-control" id="extDate">
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏á‡∏≤‡∏ô (After)</label>
      <input type="file" class="form-control" id="imageFile" accept="image/*">
      <img id="preview" class="preview-img hidden">
    </div>

    <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </form>
</div>

<script>
  // üî• ‡πÅ‡∏Å‡πâ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏£‡∏±‡∏ö
  const LIFF_ID = "2008866702-1kmRkgC8"; 
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbwrPOLJFauOPQ9clmnrnxAn-jcw5SjJONa4Ax-4Dn-V43YOBKpudo3NOSAjHk3HWF2w/exec"; 

  let params = new URLSearchParams(window.location.search);
  let jobId = params.get('jobId');
  let mode = params.get('mode'); 
  let userId = "";
  let displayName = "";

  window.onload = async function() {
    document.getElementById('jobIdDisplay').innerText = jobId || "-";
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
    if (mode === 'external') {
      document.getElementById('pageTitle').innerText = "üõ†Ô∏è ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏° / ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
      document.getElementById('pageTitle').className = "fw-bold text-warning";
      document.getElementById('extDateGroup').classList.remove('hidden');
      document.getElementById('extDate').required = true;
    }

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Login)
    fetchJobDetails();

    // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö LIFF Login
    await initializeLiff();
  };

  // üÜï ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å GAS
  function fetchJobDetails() {
    if(!jobId) return;
    
    fetch(GAS_EXEC_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'get_job_detail', jobId: jobId })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('loadingDetail').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏•‡∏î
        if(data.status === 'success') {
            document.getElementById('jobDetailSection').classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á
            document.getElementById('txtDetail').innerText = data.detail;
            document.getElementById('txtLocation').innerText = data.location;
            document.getElementById('txtReporter').innerText = data.reporter;
        }
    })
    .catch(err => console.log("Fetch Error:", err));
  }

  async function initializeLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        
        document.getElementById('userProfile').classList.remove('hidden');
        document.getElementById('userPicture').src = profile.pictureUrl;
        document.getElementById('userName').innerText = displayName;
      }
    } catch (err) {
      alert("LIFF Error: " + err);
    }
  }

  // Preview ‡∏£‡∏π‡∏õ
  document.getElementById('imageFile').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
      let reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview').src = e.target.result;
        document.getElementById('preview').classList.remove('hidden');
      }
      reader.readAsDataURL(e.target.files[0]);
    }
  });

  // Submit Form
  document.getElementById('closeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    document.getElementById('loadingOverlay').style.display = 'flex';

    let file = document.getElementById('imageFile').files[0];
    if (file) {
      let reader = new FileReader();
      reader.onload = function(e) { submitData(e.target.result); }
      reader.readAsDataURL(file);
    } else {
      submitData(""); 
    }
  });

  function submitData(base64Image) {
    let payload = {
      action: 'close_job',
      jobId: jobId,
      mode: mode,
      userId: userId,        
      userName: displayName, 
      remark: document.getElementById('remark').value,
      material: document.getElementById('material').value,
      extDate: document.getElementById('extDate').value,
      image: base64Image
    };

    fetch(GAS_EXEC_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('loadingOverlay').style.display = 'none';
      if (data.status === 'success') {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        liff.closeWindow();
      } else {
        alert("‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
      }
    })
    .catch(err => {
      document.getElementById('loadingOverlay').style.display = 'none';
      alert("Error: " + err);
    });
  }
</script>

</body>
</html>
