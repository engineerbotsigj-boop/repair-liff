<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Sarabun', sans-serif; }
    .hidden { display: none; }
    .preview-img { max-width: 100%; height: auto; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status"></div>
  <div class="mt-2 text-primary fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<div class="container" style="max-width: 600px;">
  <div class="text-center mb-4">
    <h4 id="pageTitle" class="fw-bold text-primary">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ‚úÖ</h4>
    <p class="text-muted small">Job ID: <span id="jobIdDisplay" class="badge bg-secondary">...</span></p>
    <div id="userProfile" class="d-flex justify-content-center align-items-center gap-2 hidden">
        <img id="userPicture" src="" style="width: 30px; height: 30px; border-radius: 50%;">
        <span id="userName" class="small text-dark fw-bold"></span>
    </div>
  </div>

  <form id="closeForm">
    <div class="mb-3">
      <label class="form-label fw-bold">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° / ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea class="form-control" id="remark" rows="3" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏ã‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå, ‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÉ‡∏´‡∏°‡πà"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">üî© ‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
      <input type="text" class="form-control" id="material" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü LED 18W x 2 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)">
    </div>

    <div class="mb-3 hidden" id="extDateGroup">
      <label class="form-label text-danger fw-bold">üìÖ ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" class="form-control" id="extDate">
    </div>

    <div class="mb-4">
      <label class="form-label fw-bold">üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏á‡∏≤‡∏ô (After)</label>
      <input type="file" class="form-control" id="imageFile" accept="image/*">
      <img id="preview" class="preview-img hidden">
    </div>

    <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </form>
</div>

<script>
  // üî• ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
  const LIFF_ID = "YOUR_NEW_LIFF_ID"; // ‡πÄ‡∏≠‡∏≤ LIFF ID ‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbwrPOLJFauOPQ9clmnrnxAn-jcw5SjJONa4Ax-4Dn-V43YOBKpudo3NOSAjHk3HWF2w/exec"; // ‡∏•‡∏¥‡∏á‡∏Å‡πå Exec ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å GAS

  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
  let params = new URLSearchParams(window.location.search);
  let jobId = params.get('jobId');
  let mode = params.get('mode'); 
  let userId = "";
  let displayName = "";

  // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î
  window.onload = async function() {
    document.getElementById('jobIdDisplay').innerText = jobId || "-";
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏´‡∏°‡∏î (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô vs ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°)
    if (mode === 'external') {
      document.getElementById('pageTitle').innerText = "üõ†Ô∏è ‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏° / ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà";
      document.getElementById('pageTitle').className = "fw-bold text-warning";
      document.getElementById('extDateGroup').classList.remove('hidden');
      document.getElementById('extDate').required = true;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF
    await initializeLiff();
  };

  // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô LIFF Login
  async function initializeLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        
        // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ Profile ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß
        document.getElementById('userProfile').classList.remove('hidden');
        document.getElementById('userPicture').src = profile.pictureUrl;
        document.getElementById('userName').innerText = displayName;
      }
    } catch (err) {
      console.error(err);
      alert("LIFF Error: " + err);
    }
  }

  // 3. Preview ‡∏£‡∏π‡∏õ
  document.getElementById('imageFile').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
      let reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview').src = e.target.result;
        document.getElementById('preview').classList.remove('hidden');
      }
      reader.readAsDataURL(e.target.files[0]);
    }
  });

  // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Submit)
  document.getElementById('closeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    document.getElementById('loadingOverlay').style.display = 'flex';

    let file = document.getElementById('imageFile').files[0];
    if (file) {
      let reader = new FileReader();
      reader.onload = function(e) {
        submitData(e.target.result); 
      }
      reader.readAsDataURL(file);
    } else {
      submitData(""); 
    }
  });

  function submitData(base64Image) {
    let payload = {
      action: 'close_job',
      jobId: jobId,
      mode: mode,
      userId: userId,        // ‡∏™‡πà‡∏á UserID ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      userName: displayName, // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      remark: document.getElementById('remark').value,
      material: document.getElementById('material').value,
      extDate: document.getElementById('extDate').value,
      image: base64Image
    };

    // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ GAS (‡πÉ‡∏ä‡πâ fetch mode: 'no-cors' ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π response)
    // ‡πÅ‡∏ï‡πà GAS Web App ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö TextOutput ‡πÉ‡∏´‡πâ fetch ‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏î‡πâ
    fetch(GAS_EXEC_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('loadingOverlay').style.display = 'none';
      if (data.status === 'success') {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        liff.closeWindow();
      } else {
        alert("‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
      }
    })
    .catch(err => {
      document.getElementById('loadingOverlay').style.display = 'none';
      alert("Error: " + err);
    });
  }
</script>

</body>
</html>
