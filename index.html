<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background-color: #f8f9fa; padding: 20px; font-family: 'Sarabun', sans-serif; }
    .required::after { content: " *"; color: red; }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.98); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-secondary" id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...</p>
  </div>

  <div class="container hidden" id="mainForm">
    <h4 class="text-center mb-4">üìù ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</h4>
    
    <form id="repairForm">
      <input type="hidden" id="userId">

      <div class="mb-3"><label class="form-label required">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" class="form-control" id="name" required></div>
      <div class="row">
        <div class="col-6 mb-3"><label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" class="form-control" id="dept"></div>
        <div class="col-6 mb-3"><label class="form-label required">‡∏ù‡πà‡∏≤‡∏¢/‡∏á‡∏≤‡∏ô</label><input type="text" class="form-control" id="division" required></div>
      </div>
      <div class="mb-3"><label class="form-label required">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" class="form-control" id="phone" required></div>

      <hr>

      <div class="mb-3">
        <label class="form-label required">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</label>
        <select class="form-select" id="building" required onchange="updateFloors()">
          <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
          <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ø (‡πÄ‡∏î‡∏¥‡∏°)">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ø (‡πÄ‡∏î‡∏¥‡∏°)</option>
          <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ø (‡πÇ‡∏ã‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 2)">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ø (‡πÇ‡∏ã‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 2)</option>
          <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏ö‡∏£‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏ö‡∏£‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå</option>
          <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏õ‡∏±‡∏ô‡∏£‡∏±‡∏Å‡∏©‡πå">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏õ‡∏±‡∏ô‡∏£‡∏±‡∏Å‡∏©‡πå</option>
          <option value="‡∏ï‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ø">‡∏ï‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ø</option>
          <option value="‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ñ‡∏∏‡πâ‡∏°‡∏†‡∏±‡∏¢">‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ñ‡∏∏‡πâ‡∏°‡∏†‡∏±‡∏¢</option>
          <option value="‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢">‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢</option>
          <option value="‡∏ö‡πà‡∏≠‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢">‡∏ö‡πà‡∏≠‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="row">
        <div class="col-6 mb-3"><label class="form-label required">‡∏ä‡∏±‡πâ‡∏ô</label><select class="form-select" id="floor" required disabled><option value="">-</option></select></div>
        <div class="col-6 mb-3"><label class="form-label required">‡∏´‡πâ‡∏≠‡∏á/‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì</label><input type="text" class="form-control" id="room" required></div>
      </div>

      <div class="mb-3">
        <label class="form-label required">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
        <select class="form-select" id="type" required>
          <option value="‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
          <option value="‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
          <option value="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•</option>
          <option value="‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
          <option value="‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Å‡πä‡∏™‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå">‡πÅ‡∏Å‡πä‡∏™‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
          <option value="‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå">‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>
      <div class="mb-3"><label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" class="form-control" id="assetId"></div>
      <div class="mb-3"><label class="form-label required">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea class="form-control" id="detail" rows="3" required></textarea></div>
      <div class="mb-3"><label class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏π‡∏õ)</label><input type="file" class="form-control" id="photos" multiple accept="image/*"><div id="preview" class="mt-2 d-flex flex-wrap gap-2"></div></div>

      <button type="submit" class="btn btn-primary w-100 py-2">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
    </form>
  </div>

  <script>
    // üö®üö® ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 (Google Apps Script) ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üö®üö®
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwrPOLJFauOPQ9clmnrnxAn-jcw5SjJONa4Ax-4Dn-V43YOBKpudo3NOSAjHk3HWF2w/exec';
    
    // ‡πÉ‡∏™‡πà LIFF ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const LIFF_ID = '2008863780-Mox0bjZV';

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Login (GitHub ‡∏ó‡∏≥‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà Error)
          return;
        }
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        
        loadSavedData();
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainForm').classList.remove('hidden');
      } catch (err) { alert("LIFF Error: " + err); }
    }
    main();

    document.getElementById('repairForm').addEventListener('submit', function(e) {
      e.preventDefault();
      document.getElementById('loadingOverlay').classList.remove('hidden');
      document.getElementById('statusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      
      localStorage.setItem('rep_name', document.getElementById('name').value);
      localStorage.setItem('rep_dept', document.getElementById('dept').value);
      localStorage.setItem('rep_division', document.getElementById('division').value);
      localStorage.setItem('rep_phone', document.getElementById('phone').value);

      const formData = {
        userId: document.getElementById('userId').value,
        name: document.getElementById('name').value,
        dept: document.getElementById('dept').value,
        division: document.getElementById('division').value,
        phone: document.getElementById('phone').value,
        building: document.getElementById('building').value,
        floor: document.getElementById('floor').value,
        room: document.getElementById('room').value,
        type: document.getElementById('type').value,
        assetId: document.getElementById('assetId').value,
        detail: document.getElementById('detail').value,
        images: processedImages
      };

      fetch(GAS_URL, {
        method: 'POST',
        mode: 'no-cors', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })
      .then(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        liff.closeWindow();
      })
      .catch(err => {
        alert("Error: " + err);
        document.getElementById('loadingOverlay').classList.add('hidden');
      });
    });

    // Helper Functions
    function updateFloors() {
       const b = document.getElementById('building').value;
       const f = document.getElementById('floor');
       f.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>'; f.disabled = false;
       let max = (b.includes('‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå') || b.includes('‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏ö‡∏£‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå')) ? 5 : 
                 (b.includes('‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤‡∏õ‡∏±‡∏ô‡∏£‡∏±‡∏Å‡∏©‡πå') ? 3 : (b.includes('‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') ? 1 : 10));
       for(let i=1; i<=max; i++) f.innerHTML += `<option value="${i}">${i}</option>`;
    }

    let processedImages = [];
    document.getElementById('photos').addEventListener('change', function(e) {
      const files = e.target.files;
      document.getElementById('preview').innerHTML = ''; processedImages = [];
      for (let i=0; i<Math.min(files.length, 5); i++) {
         const reader = new FileReader();
         reader.onload = function(ev) {
            const img = new Image();
            img.onload = function() {
               const cvs = document.createElement('canvas'); 
               const ctx = cvs.getContext('2d');
               let w = img.width, h = img.height;
               if(w>1000){ h*=1000/w; w=1000; }
               cvs.width=w; cvs.height=h;
               ctx.drawImage(img,0,0,w,h);
               processedImages.push(cvs.toDataURL('image/jpeg', 0.7));
               document.getElementById('preview').innerHTML += `<img src="${cvs.toDataURL()}" style="width:60px;height:60px;object-fit:cover;">`;
            }
            img.src = ev.target.result;
         }
         reader.readAsDataURL(files[i]);
      }
    });
    
    function loadSavedData() {
      if(localStorage.getItem('rep_name')) document.getElementById('name').value = localStorage.getItem('rep_name');
      if(localStorage.getItem('rep_dept')) document.getElementById('dept').value = localStorage.getItem('rep_dept');
      if(localStorage.getItem('rep_division')) document.getElementById('division').value = localStorage.getItem('rep_division');
      if(localStorage.getItem('rep_phone')) document.getElementById('phone').value = localStorage.getItem('rep_phone');
    }
  </script>
</body>
</html>
